## 4 油门标定

车辆在某一速度基础上，需要通过车辆的油门和刹车来获得期望加速度。汽车在不同的行驶速度下，想要获取相同的加速度，则其油门和刹车的大小也会不同。我们需要获取汽车速度和加速度之间的关系来更好的实现对车辆的控制，本节内容利用apollo的标定工具来实现汽车的油门刹车标定表。

#### 4.1 油门数据采集

1. 启动SVL， 建立仿真车辆同apollo的通信，在cyber_monitor中查看汽车发来的数据

2. 在docker容器中，启动apollo系统 

   ```
   bash bash scripts/bootstrap_lgsvl.sh
   ```

   在`DreamViewer`下运行 选择 车型`MkzExample`,模式·`Mkz Standard Debug`,地图`Borregas Ave`,打开`Transform`、`Localization`单元,DreamView会加载出车辆及高精地图。

3. 选择标定场地，手动控制汽车至具有一段较长的公路上

   ![](4%20%E6%B2%B9%E9%97%A8%E6%A0%87%E5%AE%9A.assets/2022-03-12%2020-41-38%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE-16492116931861.png)

4. apollo的容器中缺少我们运行标定工具所需的依赖环境吗，需要运行我们的脚本文件对其进行安装

   ```bash
   bash supplement/update_docker.sh
   ```

5. 数据收集

   > note1：在进行油门标定的过程中我们需要获采集车身的速度以及加速度`corrected_imu`, 在SVL仿真器中存在一个bug，汽车发出来的`corrected_imu`内的消息一直为0,导致无法完成标定。故我们通过采集`imu_raw`和`odometry`信息，通过处理我们自己来发布出一个正确的`corrected_imu`供汽车的油门刹车标定。

   > note2: 通过查阅SVL源码，发现SVL发布的消息`/apollo/sensor/gnss/imu`中IMU的坐标系为前左上，`/apollo/sensor/gnss/odometry`发布的消息中GPS的坐标系为右前上且为`右乘`，基于此我们开始编程生成我们所需要的`corrected_imu`
   >

   ```bash
   ./bazel-bin/modules/tools/vehicle_calibration/data_collector
   ```

   ![](4%20%E6%B2%B9%E9%97%A8%E6%A0%87%E5%AE%9A.assets/2022-03-12%2020-50-42%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE-16492116984952.png)

   根据提示，x,y,z分别为油门、速度、 刹车。我们通过多次尝试来决定汽车的油门死区，在此基础上不断更改这三个变量值。 

   | x    | y    | z    | x    | y    | z    |
   | ---- | ---- | ---- | ---- | ---- | ---- |
   | 6    | 1    | -10  | 10   | 2    | -15  |
   | 6    | 1.5  | -12  | 10   | 3    | -10  |
   | 8    | 1    | -10  | 15   | 3    | -20  |
   | 8    | 1.5  | -10  | 20   | 4    | -19  |
   | 15   | 8    | -30  | 80   | 4    | -30  |
   | 20   | 7    | -60  | 80   | 5    | -80  |
   

这些采集的数据均保存在`apollo`的根目录下，如`“t6b-10r0_recorded.csv”`,讲这些数据打包，移动至新建文件夹“vehicle_calibration_data”

```bash
   mkdir vehicle_calibration_data && mv *csv ./vehicle_calibration_data
```

6. 数据处理

   ```bash
   bash modules/tools/vehicle_calibration/process_data.sh vehicle_calibration_data
   ```

   在apollo的根目录下，会生成文件`result.csv`

7. 查看标定结果

   ```bash
    ./bazel-bin/modules/tools/vehicle_calibration/plot_results result.csv
   ```
   
   ![](4%20%E6%B2%B9%E9%97%A8%E6%A0%87%E5%AE%9A.assets/2022-04-06%2010-20-54%20%E7%9A%84%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE-16492117089206.png)
   
8.  生成protobuf标定文件

     ```
     bash modules/tools/vehicle_calibration/result2pb.sh result.csv 
     ```

    在执行终端的目录下会生成`control_conf.pb.txt` 的控制器相关的配置文件，包括横纵向控制器参数及油门刹车标定表，将该文件拷贝至车辆文件中`/apollo/modules/calibration/data/Lincoln2017MKZ`，在`DreamViewer`中每次重新选择车辆时，会自动将该文件加载至`/apollo/modules/control/conf`文件夹下。







1. ./baz间戳问题，目前IMU时间戳明显落后，查询gnss时间戳	

   经查证，IMU时间是错的，不用管。

   gnss_odometry之前默认12.5hz，更改为100hz

2. 在apollo中手写一个工具，订阅raw_imu and gnss_odometry，订阅之后在直接吐出去









